name: Code deploy

on:
  workflow_dispatch: # 이 태그가 있으면 workflow를 매뉴얼하게 트리거할 수 있음.
  push: # push할 때 작동
    branches: # 대상이 될 브랜치
      - main
      
jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v2

      - name: Create SSH Key
        run: | # access key를 actions 내부 워크스페이스에 pem파일로 저장하고 권한을 확보
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/ralo.pem
          chmod 600 ~/.ssh/ralo.pem
      - name: Add known host
        run: |
          ssh-keyscan -p ${{ secrets.SSH_PORT }} \
            -t rsa,ecdsa,ed25519 \
            ${{ secrets.SSH_HOST }} \
            >> ~/.ssh/known_hosts
      # 3) SSH로 서버 접속 후 배포
      - name: Deploy to server via SSH
        run: |
          echo "== [DEPLOY] SSH 접속 시작 =="
          ssh -i ~/.ssh/ralo.pem -p ${{ secrets.SSH_PORT }} ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << 'EOF'
            echo "== [서버 접속 성공] =="
            set -e
            echo "== (1) 프로젝트 디렉토리 이동 =="
            cd ${{ secrets.PROJECT_PATH }} || { echo "❌ 디렉토리 이동 실패"; exit 1; }
            echo "== (2) Git 최신 코드 가져오기 =="
            git fetch origin main || { echo "❌ git fetch 실패"; exit 1; }
            git reset --hard origin/main || { echo "❌ git reset 실패"; exit 1; }
            echo "== (3) Docker 이미지 빌드 =="
            docker build -t pw3ai:latest . || { echo "❌ Docker 빌드 실패"; exit 1; }
            echo "== (4) 기존 컨테이너 중지 및 삭제 =="
            if [ "$(docker ps -a -q -f name=pw3ai)" ]; then
              echo "컨테이너가 이미 존재합니다. 중지 및 삭제를 시도합니다."
              docker stop pw3ai || echo "⚠️ 컨테이너 중지 실패 (무시)"
              docker rm pw3ai || echo "⚠️ 컨테이너 삭제 실패 (무시)"
            else
              echo "기존 컨테이너가 없습니다."
            fi
            echo "== (5) 새 컨테이너 실행 =="
            docker run -d \
              --name pw3ai \
              --network attendance-deploy_attendance-net \
              -p 8084:8084 \
              --label traefik.enable=true \
              --label 'traefik.http.routers.pw3ai.rule=Host(`pw3ai.porogramr.site`)' \
              --label traefik.http.routers.pw3ai.entrypoints=websecure \
              --label traefik.http.routers.pw3ai.tls=true \
              --label traefik.http.routers.pw3ai.tls.certresolver=letsencrypt \
              --label traefik.http.services.pw3ai.loadbalancer.server.port=8084 \
              -e "GOOGLE_API_KEY=${{ secrets.GOOGLE_API_KEY }}" \
              -e "MYSQL_URL=${{ secrets.MYSQL_URL }}" \
              -v "${{ secrets.PROJECT_PATH }}/attendance.db:/app/attendance.db" \
              pw3ai:latest || { echo "❌ 컨테이너 실행 실패"; exit 1; }
            echo "== (6) 컨테이너 로그 확인 (마지막 100줄) =="
            docker logs pw3ai --tail 100 || echo "⚠️ 로그 확인 실패 (무시)"
            echo "✅ [DEPLOY 완료]"
          EOF
        shell: bash
